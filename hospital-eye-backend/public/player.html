  <!doctype html>
  <html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Hospital Eye ‚Äî Camera Console</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root{
        --bg:#0b0f14;
        --panel:#121821;
        --panel-2:#0e141c;
        --text:#eef3f8;
        --muted:#9fb0c3;
        --brand:#6aa7ff;
        --brand-2:#4ad6b7;
        --danger:#ff5d6c;
        --warn:#ffb64d;
        --ok:#3ccf91;
        --ring:rgba(106,167,255,.35);
        --shadow:0 10px 30px rgba(0,0,0,.35);
        --radius:14px;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;background:linear-gradient(120deg,#0b0f14 0%, #0c1320 100%);
        color:var(--text); font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;
        display:grid; grid-template-columns: 320px 1fr; gap:20px; padding:20px;
      }
      /* Sidebar */
      .sidebar{
        background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
        border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow);
        padding:16px; display:flex; flex-direction:column; gap:14px; min-height:0;
      }
      .brand{display:flex;align-items:center;gap:8px;font-weight:700;letter-spacing:.4px}
      .brand .dot{width:8px;height:8px;border-radius:999px;background:var(--brand-2);box-shadow:0 0 0 6px rgba(74,214,183,.15)}
      .muted{color:var(--muted)}
      .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
      .field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:140px}
      label{font-size:12px;color:var(--muted)}
      input,select,button,details summary{
        border:1px solid rgba(255,255,255,.08);
        background:#0f1621;color:var(--text);
        padding:10px 12px;border-radius:10px;outline:none;
      }
      input:focus,select:focus,button:focus,details[open] summary{box-shadow:0 0 0 3px var(--ring)}
      button{cursor:pointer;border:none;background:linear-gradient(180deg,#3259ff,#6aa7ff); transition:.15s}
      button:hover{filter:brightness(1.08)}
      .btn-ghost{background:#111825}
      .btn-danger{background:linear-gradient(180deg,#ff3a55,#ff7381)}
      .btn-outline{background:transparent;border:1px solid rgba(255,255,255,.15)}
      details{border:1px dashed rgba(255,255,255,.12); border-radius:12px; padding:8px}
      details summary{list-style:none;background:#121b28; cursor:pointer}
      details[open]{border-style:solid}
      .list{display:flex;flex-direction:column;gap:8px}
      .bar{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent)}
  
      /* Main */
      .main{
        display:grid; grid-template-rows:auto 1fr; gap:14px; min-width:0; min-height:0;
      }
      .toolbar{
        background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
        border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow);
        padding:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      }
      .pill{padding:6px 10px;border-radius:999px;font-weight:600}
      .live{background:rgba(60,207,145,.15); color:var(--ok); border:1px solid rgba(60,207,145,.35)}
      .status-dot{width:10px;height:10px;border-radius:999px;background:#999}
      .status.ok{background:var(--ok)} .status.err{background:var(--danger)}
      .grow{flex:1}
      .video-card{
        background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
        border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow);
        padding:12px; display:grid; grid-template-rows:auto 1fr; gap:10px; min-height:0;
      }
      .video-wrap{position:relative; display:flex; justify-content:center; align-items:center; min-height:360px; height:calc(100vh - 220px)}
      video{width:100%; height:100%; object-fit:contain; background:#000; border-radius:12px}
  
      .overlay{
        position:absolute; inset:auto 12px 12px auto; display:flex; gap:8px; align-items:center;
        background:rgba(0,0,0,.45); padding:6px 10px; border-radius:10px; backdrop-filter: blur(6px);
        border:1px solid rgba(255,255,255,.12); font-weight:600
      }
      /* HUD (top-left) */
      #hud{
        position:absolute; top:12px; left:12px; display:none;
        background:rgba(0,0,0,.45); padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
        backdrop-filter: blur(6px); font-weight:600
      }
      #hud .k{color:var(--muted); margin-right:6px}

      /* MP4-style analytics overlay */
      .analytics-overlay{
        position:absolute; top:20px; right:20px; background:rgba(0,0,0,.8);
        padding:16px; border-radius:10px; border:2px solid var(--ok); z-index:5; min-width:200px;
      }
      .analytics-item{display:flex; justify-content:space-between; margin-bottom:8px}
      .analytics-label{color:var(--ok); font-weight:700}
      .analytics-value{color:#fff}
  
      /* Toast */
      .toast{position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column; gap:8px; z-index:9999}
      .toast .t{
        background:#101722; border:1px solid rgba(255,255,255,.08); padding:10px 12px; border-radius:10px;
        box-shadow:var(--shadow); min-width:260px
      }
  
      /* Spinner */
      .spinner{display:none;position:absolute;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,.35);border-radius:12px}
      .spinner.show{display:flex}
      .spinner:after{
        content:"";width:36px;height:36px;border-radius:50%;
        border:3px solid rgba(255,255,255,.15); border-top-color:var(--brand); animation:spin .9s linear infinite
      }
      @keyframes spin{to{transform:rotate(360deg)}}
  
      /* Canvas overlay for line */
      #overlayCanvas{position:absolute; inset:0; pointer-events:none;}
  
      @media (max-width:980px){
        body{grid-template-columns:1fr}
        .video-wrap{height:55vh}
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand"><span class="dot"></span> Hospital Eye <span class="muted">/ Cameras</span></div>
  
      <div class="list">
        <div class="field">
          <label>Saved cameras</label>
          <select id="camera"></select>
        </div>
  
        <div class="row">
          <div class="field">
            <label>Channel (NVR: CH4 = 3)</label>
            <input id="chn" value="0" inputmode="numeric" />
          </div>
          <div class="field">
            <label>Stream</label>
            <select id="streamOverride">
              <option value="sub" selected>sub (H.264)</option>
              <option value="main">main (HEVC)</option>
            </select>
          </div>
        </div>
  
        <div class="row">
          <label class="muted"><input type="checkbox" id="force" /> force H.264 encode (only if main/HEVC)</label>
        </div>
  
        <div class="row">
          <button id="play">‚ñ∂ Play</button>
          <button class="btn-ghost" id="stop">‚èπ Stop</button>
          <button class="btn-outline" id="open">m3u8</button>
          <button class="btn-danger grow" id="remove">Remove</button>
        </div>
      </div>
  
      <div class="bar"></div>
  
      <details>
        <summary>‚ûï Add camera</summary>
        <div class="row" style="margin-top:10px">
          <div class="field"><label>Name</label><input id="name" placeholder="IV Room" /></div>
          <div class="field"><label>IP</label><input id="ip" placeholder="142.129.133.153" /></div>
          <div class="field"><label>RTSP Port</label><input id="port" value="555" /></div>
        </div>
        <div class="row">
          <div class="field"><label>User</label><input id="user" value="admin" /></div>
          <div class="field"><label>Password</label><input id="pass" type="password" /></div>
        </div>
        <div class="row">
          <div class="field">
            <label>Default stream</label>
            <select id="stream">
              <option value="sub" selected>sub (H.264)</option>
              <option value="main">main (HEVC)</option>
            </select>
          </div>
          <div class="field"><label>Default channel</label><input id="defCh" value="0" /></div>
        </div>
        <div class="row"><button id="add">Add camera</button></div>
      </details>
  
      <div class="muted" style="font-size:12px; margin-top:auto">
        Tip: Reolink NVR channels are 1-based; UI CH4 ‚áí channel <b>3</b>.
      </div>
    </aside>
  
    <!-- Main -->
    <main class="main">
      <div class="toolbar">
        <span class="pill live">LIVE</span>
        <div id="meta" class="muted">No camera selected</div>
        <div class="grow"></div>
  
        <!-- NEW: analytics controls -->
        <button class="btn-outline" id="startAnalytics">Start Analytics</button>
        <button class="btn-ghost"   id="stopAnalytics">Stop Analytics</button>

        <!-- MP4-style quick controls -->
        <div class="row" style="gap:8px">
          <label class="muted" style="font-size:12px">Conf <span id="confidenceValue">60%</span></label>
          <input type="range" id="confidenceSlider" min="30" max="90" value="60" />
          <label class="muted" style="font-size:12px">Smooth <span id="smoothingValue">5</span></label>
          <input type="range" id="smoothingSlider" min="1" max="10" value="5" />
          <label class="muted" style="font-size:12px">High <span id="hysteresisHighValue">75%</span></label>
          <input type="range" id="hysteresisHighSlider" min="60" max="95" value="75" />
          <label class="muted" style="font-size:12px">Low <span id="hysteresisLowValue">45%</span></label>
          <input type="range" id="hysteresisLowSlider" min="20" max="70" value="45" />
        </div>
  
        <div class="row">
          <div class="status-dot status" id="statusDot" title="stream status"></div>
          <span class="muted" id="statusText">idle</span>
        </div>
      </div>
  
      <section class="video-card">
        <div class="video-wrap" id="playerWrap">
          <video id="v" controls autoplay playsinline></video>
          <canvas id="overlayCanvas"></canvas>
          <div id="hud"><span class="k">In</span><span id="in">0</span> &nbsp; <span class="k">Out</span><span id="out">0</span> &nbsp; <span class="k">Occ</span><span id="occ">0</span></div>
          <div class="spinner" id="spinner"></div>
          <div class="overlay">
            <button class="btn-outline" id="btnFS">Fullscreen</button>
          </div>
          <!-- MP4-style metrics overlay -->
          <div id="analyticsOverlay" class="analytics-overlay" style="display:none">
            <h3 style="margin:0 0 8px 0">üìä Real-Time Analytics</h3>
            <div class="analytics-item"><span class="analytics-label">People Detected:</span><span id="peopleCount" class="analytics-value">0</span></div>
            <div class="analytics-item"><span class="analytics-label">Detection Confidence:</span><span id="confidenceLevel" class="analytics-value">0%</span></div>
            <div class="analytics-item"><span class="analytics-label">FPS:</span><span id="fpsCounter" class="analytics-value">0</span></div>
            <div class="analytics-item"><span class="analytics-label">Status:</span><span id="detectionStatus" class="analytics-value">Idle</span></div>
          </div>
        </div>
      </section>
    </main>
  
    <!-- Toasts -->
    <div class="toast" id="toast"></div>
  
    <!-- hls.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- Add TFJS + coco-ssd to mirror mp4-player analytics overlay -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>
    <script>
      /* ---------- tiny utils ---------- */
      const $ = (s)=>document.querySelector(s);
      const $id = (s)=>document.getElementById(s);
      function toast(msg, type='info'){
        const box = $id('toast'); const t = document.createElement('div');
        t.className='t'; t.textContent = msg;
        if (type==='err') t.style.borderColor='rgba(255,93,108,.5)';
        if (type==='ok')  t.style.borderColor='rgba(60,207,145,.5)';
        box.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(6px)'; }, 3200);
        setTimeout(()=>box.removeChild(t), 3800);
      }
      function setStatus(ok, text){
        $id('statusDot').className = 'status-dot status ' + (ok ? 'ok' : 'err');
        $id('statusText').textContent = text || (ok ? 'playing' : 'error');
      }
      function busy(on=true){ $id('spinner').classList.toggle('show', on); }
  
      async function fetchJSON(url, opts){ const r = await fetch(url, opts); return r.json(); }
      async function waitFor(url, tries=60, delay=500){
        for (let i=0;i<tries;i++){ const r = await fetch(url,{cache:'no-store'}); if(r.ok) return true; await new Promise(rs=>setTimeout(rs,delay)); }
        return false;
      }
      function getSelectedCameraId() {
        const sel = $id('camera'); return sel && sel.value ? sel.value : null;
      }
  
      /* ---------- state ---------- */
      let currentHls = null;
      let lastCam = null;
  
      // NEW: analytics state
      let statsTimer = null;
      let currentCameraId = null;
      let currentLine = null;

      // Client-side detection (like mp4-player)
      let detectionModel = null;
      let detectionRunning = false;
      let confidenceThreshold = 0.6;  // 60%
      let smoothingFrames = 5;        // last N frames
      let hysteresisHigh = 0.75;      // confirm detection
      let hysteresisLow  = 0.45;      // confirm loss
      let detectionHistory = [];
      let stableCount = 0;
      let lastStableCount = 0;
      let lastTime = 0;               // for FPS
  
      const VIDEO  = $id('v');
      VIDEO.crossOrigin = 'anonymous';     // <‚Äî allow pixel reads by TFJS when CORS is correct
      VIDEO.playsInline = true;
      VIDEO.muted = true;
      const CANVAS = $id('overlayCanvas');
      const HUD    = $id('hud');
      const IN_EL  = $id('in');
      const OUT_EL = $id('out');
      const OCC_EL = $id('occ');
  
      /* ---------- load cameras into dropdown ---------- */
      async function loadCameras(){
        const cams = await fetchJSON('/api/cameras');
        const sel = $id('camera');
        sel.innerHTML = cams.map(c =>
          `<option value="${c._id}" data-defch="${c.defaultChannel||0}" data-defstream="${c.defaultStream||'sub'}">
            ${c.name} (${c.ip}:${c.rtspPort})
           </option>`).join('');
        if (cams.length){
          const first = cams[0];
          $id('chn').value = first.defaultChannel ?? 0;
          $id('streamOverride').value = first.defaultStream ?? 'sub';
          $id('meta').textContent = `${first.name} ‚Äî ${first.ip}:${first.rtspPort}`;
        } else {
          $id('meta').textContent = 'No camera selected';
        }
        return cams;
      }
  
      $id('camera').addEventListener('change', async (e)=>{
        const id = e.target.value;
        const meta = await fetchJSON('/api/cameras/'+id).catch(()=>null);
        if (meta) {
          $id('chn').value = Number(meta.defaultChannel || 0);
          $id('streamOverride').value = meta.defaultStream || 'sub';
          $id('meta').textContent = `${meta.name} ‚Äî ${meta.ip}:${meta.rtspPort}`;
        }
      });
  
      /* ---------- streaming actions ---------- */
      async function playSelected(){
        const id = $id('camera').value;
        if(!id){ toast('No cameras saved yet. Add one first.','err'); return; }
  
        const channel = Number($id('chn').value || 0);
        const stream = $id('streamOverride').value;
        const forceEncode = $id('force').checked;
  
        busy(true); setStatus(true,'starting‚Ä¶');
        // Stop first so channel/stream changes take effect
        await fetchJSON(`/api/cameras/${id}/stop`, { method:'POST' }).catch(()=>{});
        const resp = await fetchJSON(`/api/cameras/${id}/start`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ useSystemFfmpeg:true, channel, stream, forceEncode })
        });
        if(!resp.ok){ busy(false); setStatus(false,'start failed'); toast('Start failed: '+JSON.stringify(resp),'err'); return; }
  
        const hlsUrl = resp.hls.startsWith('/') ? resp.hls : '/'+resp.hls;
        const ok = await waitFor(hlsUrl, 60, 300);
        if(!ok){ busy(false); setStatus(false,'playlist not ready'); toast('Playlist not ready. Check server logs.','err'); return; }
  
        if (currentHls) { currentHls.destroy(); currentHls = null; }
        if (Hls.isSupported()){
          currentHls = new Hls({ lowLatencyMode:false, maxBufferLength:12, maxMaxBufferLength:30, liveSyncDuration:6 });
          currentHls.on(Hls.Events.ERROR, (_e, data)=>{ console.error('hls.js error', data); toast('Player error (see console)','err'); });
          currentHls.loadSource(hlsUrl);
          currentHls.attachMedia(VIDEO);
        } else { VIDEO.src = hlsUrl; try{ await VIDEO.play(); }catch{} }
        busy(false); setStatus(true,'playing');
        lastCam = id;
  
        // fit overlay to current video
        fitCanvas(); drawLine();
      }
  
      async function stopSelected(){
        const id = $id('camera').value;
        if(!id) return;
        await fetchJSON(`/api/cameras/${id}/stop`, { method:'POST' });
        if (currentHls) { currentHls.destroy(); currentHls = null; }
        VIDEO.removeAttribute('src'); VIDEO.load();
        setStatus(true,'idle'); toast('Stream stopped');
        // also stop analytics HUD/line
        clearAnalyticsOverlay();
      }
  
      async function removeSelected(){
        const id = $id('camera').value;
        if(!id) return;
        if(!confirm('Remove this camera?')) return;
        await fetchJSON(`/api/cameras/${id}/stop`, { method:'POST' }).catch(()=>{});
        await fetchJSON(`/api/cameras/${id}`, { method:'DELETE' });
        if (currentHls) { currentHls.destroy(); currentHls = null; }
        VIDEO.removeAttribute('src'); VIDEO.load();
        await loadCameras();
        setStatus(true,'removed'); toast('Camera removed','ok');
        clearAnalyticsOverlay();
      }
  
      async function addCamera(){
        const name = $id('name').value.trim();
        const ip   = $id('ip').value.trim();
        const rtspPort = Number($id('port').value||554);
        const username = $id('user').value.trim();
        const password = $id('pass').value;
        const defaultStream = $id('stream').value;
        const defaultChannel = Number($id('defCh').value || 0);
        if(!name||!ip||!username||!password){ toast('Fill all fields','err'); return; }
  
        const body = { name, ip, rtspPort, auth:{ username, password }, defaultStream, defaultChannel };
        const r = await fetchJSON('/api/cameras', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if(r.error){ toast('Add failed: '+r.error,'err'); return; }
        $id('name').value = ''; $id('pass').value = '';
        await loadCameras();
        toast('Camera added','ok');
      }
  
      /* ---------- analytics (CV) ---------- */
      function defaultLine(){
        const w = VIDEO.clientWidth  || 640;
        const h = VIDEO.clientHeight || 360;
        // horizontal mid-line
        return [[Math.round(w*0.1), Math.round(h*0.5)], [Math.round(w*0.9), Math.round(h*0.5)]];
      }
  
      function fitCanvas(){
        CANVAS.width  = VIDEO.clientWidth || VIDEO.videoWidth || 640;
        CANVAS.height = VIDEO.clientHeight || VIDEO.videoHeight || 360;
      }
  
      function drawLine(){
        if (!currentLine) return;
        fitCanvas();
        const ctx = CANVAS.getContext('2d');
        ctx.clearRect(0,0,CANVAS.width,CANVAS.height);
        ctx.lineWidth = 3;
        ctx.strokeStyle = 'rgba(255, 200, 0, 0.95)';
        ctx.beginPath();
        ctx.moveTo(currentLine[0][0], currentLine[0][1]);
        ctx.lineTo(currentLine[1][0], currentLine[1][1]);
        ctx.stroke();
      }

      async function ensureDetectionModel(){
        if (!detectionModel) {
          detectionModel = await cocoSsd.load();
        }
        return detectionModel;
      }

      async function runClientDetections(){
        if (!detectionRunning) return;
        try {
          await ensureDetectionModel();
          fitCanvas();
          const ctx = CANVAS.getContext('2d');
          ctx.clearRect(0,0,CANVAS.width,CANVAS.height);
          // FPS
          const now = performance.now();
          const dt = now - lastTime; lastTime = now;
          if (dt > 0) $id('fpsCounter').textContent = Math.round(1000/dt);
          // Detect
          const preds = await detectionModel.detect(VIDEO);
          ctx.lineWidth = 3;
          let peopleCount = 0; let maxConf = 0;
          for (const p of preds) {
            if (p.class === 'person' && p.score >= confidenceThreshold) {
              const [x,y,w,h] = p.bbox;
              ctx.strokeStyle = '#00ff00';
              ctx.strokeRect(x,y,w,h);
              ctx.fillStyle = '#00ff00';
              ctx.font = '14px system-ui, sans-serif';
              ctx.fillText(`Person ${(p.score*100).toFixed(1)}%`, x, Math.max(12, y-6));
              peopleCount++;
              if (p.score > maxConf) maxConf = p.score;
            }
          }
          // Smoothing + hysteresis
          detectionHistory.push(peopleCount);
          if (detectionHistory.length > smoothingFrames) detectionHistory.shift();
          const avg = detectionHistory.reduce((s,c)=>s+c,0)/(detectionHistory.length||1);
          let finalCount = stableCount;
          if (avg >= 1 && stableCount === 0) { if (avg >= hysteresisHigh) finalCount = Math.round(avg); }
          else if (avg === 0 && stableCount >= 1) { if (avg <= hysteresisLow) finalCount = 0; }
          else if (Math.abs(avg - stableCount) >= 1) { finalCount = Math.round(avg); }
          if (finalCount !== stableCount) { lastStableCount = stableCount; stableCount = finalCount; }
          // Overlay
          $id('peopleCount').textContent = stableCount;
          $id('confidenceLevel').textContent = (maxConf*100).toFixed(1) + '%';
          $id('detectionStatus').textContent = detectionRunning ? 'Running' : 'Idle';
          $id('analyticsOverlay').style.display = 'block';
          // redraw line
          if (currentLine) {
            ctx.lineWidth = 3;
            ctx.strokeStyle = 'rgba(255, 200, 0, 0.95)';
            ctx.beginPath();
            ctx.moveTo(currentLine[0][0], currentLine[0][1]);
            ctx.lineTo(currentLine[1][0], currentLine[1][1]);
            ctx.stroke();
          }
        } catch {}
        requestAnimationFrame(runClientDetections);
      }
  
      async function pollStats(){
        if (!currentCameraId) return;
        try {
          const r = await fetch(`/api/cv-events/recent?cameraId=${currentCameraId}&limit=1`, { cache: 'no-store' });
          const js = await r.json();
          const e = js.events && js.events[0];
          if (e && e.type === 'people-stats') {
            IN_EL.textContent  = e.data?.count_in ?? 0;
            OUT_EL.textContent = e.data?.count_out ?? 0;
            OCC_EL.textContent = e.data?.occupancy ?? 0;
            HUD.style.display = 'block';
          }
        } catch {}
      }
  
      function clearAnalyticsOverlay(){
        if (statsTimer) { clearInterval(statsTimer); statsTimer = null; }
        HUD.style.display = 'none';
        currentCameraId = null;
        currentLine = null;
        const ctx = CANVAS.getContext('2d'); ctx.clearRect(0,0,CANVAS.width,CANVAS.height);
        detectionRunning = false;
      }
  
      $id('startAnalytics').onclick = async () => {
        const id = getSelectedCameraId();
        if (!id) return toast('Pick a camera first','err');
        currentCameraId = id;
  
        // If no line yet, set a default and draw
        if (!currentLine) currentLine = defaultLine();
        drawLine();
  
        // Ask the CV service to start (server-side analytics)
        const body = { line: currentLine /*, stream:'sub', channel:Number($id('chn').value||0)*/ };
        const r = await fetch(`/api/cv-analytics/${id}/start`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        const data = await r.json();
        if (!data.ok) return toast('Start analytics failed: '+JSON.stringify(data),'err');
  
        // begin polling stats
        if (statsTimer) clearInterval(statsTimer);
        statsTimer = setInterval(pollStats, 2000);
        pollStats();

        // Also start client-side detection overlay like mp4-player (bounding boxes)
        detectionRunning = true;
        runClientDetections();
        toast('Analytics started','ok');
      };
  
      $id('stopAnalytics').onclick = async () => {
        const id = getSelectedCameraId();
        if (!id) return;
        await fetch(`/api/cv-analytics/${id}/stop`, { method:'POST' });
        clearAnalyticsOverlay();
        toast('Analytics stopped');
      };
  
      // Keep line/overlay sized to video
      const ro = new ResizeObserver(() => { fitCanvas(); drawLine(); });
      ro.observe($id('playerWrap'));
  
      /* ---------- wire up ---------- */
      $id('play').onclick   = playSelected;
      $id('stop').onclick   = stopSelected;
      $id('remove').onclick = removeSelected;
      $id('add').onclick    = addCamera;
      $id('open').onclick   = () => {
        const id = $id('camera').value;
        if(!id) return toast('Pick a camera first','err');
        window.open(`/streams/${id}/index.m3u8`, '_blank');
      };
      $id('btnFS').onclick  = () => {
        const el = $id('v'); if (!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.();
      };
  
      // init
      loadCameras();

      // Sliders wiring (match mp4-player)
      $id('confidenceSlider').oninput = (e)=>{
        const v = Number(e.target.value); confidenceThreshold = v/100; $id('confidenceValue').textContent = v + '%';
      };
      $id('smoothingSlider').oninput = (e)=>{
        const v = Number(e.target.value); smoothingFrames = v; $id('smoothingValue').textContent = v;
      };
      $id('hysteresisHighSlider').oninput = (e)=>{
        const v = Number(e.target.value); hysteresisHigh = v/100; $id('hysteresisHighValue').textContent = v + '%';
      };
      $id('hysteresisLowSlider').oninput = (e)=>{
        const v = Number(e.target.value); hysteresisLow = v/100; $id('hysteresisLowValue').textContent = v + '%';
      };
    </script>
  </body>
  </html>
  